version: '3.8'

services:
  openvpn:
    image: kylemanna/openvpn:2.4
    container_name: openvpn
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.default.forwarding=1
      - net.ipv6.conf.all.forwarding=1
    ports:
      - "1194:1194/udp"
      - "1194:1194/tcp"
      - "3005-3009:3005-3009/tcp"  # Port forwarding range
    volumes:
      - ./openvpn_data:/etc/openvpn:rw
      - ./client_configs:/etc/openvpn/clients:ro
      - ./logs:/var/log/openvpn:rw
    environment:
      - EASYRSA_KEY_SIZE=4096
      - EASYRSA_CA_EXPIRE=3650
      - EASYRSA_CERT_EXPIRE=3650
      - OVPN_SERVER_CN=newvps.westus.cloudapp.azure.com
      - OVPN_PORT=1194
      - OVPN_PROTO=udp
      - OVPN_NETWORK=10.8.0.0/24
      - OVPN_DNS=8.8.8.8,8.8.4.4
    healthcheck:
      test: ["CMD", "pidof", "openvpn"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    networks:
      default:
        ipv4_address: 10.8.0.1

networks:
  default:
    name: openvpn_network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.8.0.0/16
          gateway: 10.8.0.1
          ip_range: 10.8.0.0/24
    driver_opts:
      com.docker.network.bridge.name: vpn0
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.enable_icc: "false"
